
> admin-handler@1.0.0 test
> jest --verbose

  console.error
    DEBUG: Stats error: TypeError: shared_1.db.collection(...).withConverter is not a function
        at handler (/home/ripixel/dev/fitglue/server/src/typescript/admin-handler/src/index.ts:75:58)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/ripixel/dev/fitglue/server/src/typescript/admin-handler/src/index.test.ts:163:7)

       97 |       });
       98 |     } catch (e) {
    >  99 |       console.error('DEBUG: Stats error:', e);
          |               ^
      100 |       logger.error('Failed to get admin stats', { error: e });
      101 |       res.status(500).json({ error: 'Internal Server Error' });
      102 |     }

      at handler (src/index.ts:99:15)
      at Object.<anonymous> (src/index.test.ts:163:7)

  console.error
    DEBUG: Users list error: TypeError: shared_1.db.collection(...).withConverter is not a function
        at handler (/home/ripixel/dev/fitglue/server/src/typescript/admin-handler/src/index.ts:121:10)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at Object.<anonymous> (/home/ripixel/dev/fitglue/server/src/typescript/admin-handler/src/index.test.ts:214:7)

      163 |       });
      164 |     } catch (e) {
    > 165 |       console.error('DEBUG: Users list error:', e);
          |               ^
      166 |       logger.error('Failed to list admin users', { error: e });
      167 |       res.status(500).json({ error: 'Internal Server Error' });
      168 |     }

      at handler (src/index.ts:165:15)
      at Object.<anonymous> (src/index.test.ts:214:7)

FAIL src/index.test.ts
  admin-handler
    Authentication & Authorization
      ✓ returns 401 if no userId (2 ms)
      ✓ returns 403 if not admin (1 ms)
    GET /api/admin/stats
      ✕ returns platform statistics (28 ms)
    GET /api/admin/users
      ✕ returns enhanced user list with pagination (1 ms)
    GET /api/admin/users/:id
      ✓ returns full user details (1 ms)
      ✓ returns 404 if user not found
    PATCH /api/admin/users/:id
      ✕ updates user tier and admin status (2 ms)
    DELETE /api/admin/users/:id/integrations/:provider
      ✓ removes integration
    DELETE /api/admin/users/:id/pipelines/:pipelineId
      ✓ removes pipeline (1 ms)
    DELETE /api/admin/users/:id/activities
      ✓ deletes all user activities in batches (1 ms)
    GET /api/admin/executions
      ✓ returns executions list with filters (1 ms)
    GET /api/admin/executions/:id
      ✓ returns execution details
      ✓ returns 404 if execution not found (1 ms)
    Unknown paths
      ✓ returns 404 for unknown paths

  ● admin-handler › GET /api/admin/stats › returns platform statistics

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 200
    Received: 500

    Number of calls: 1

      163 |       await handler(req, res, ctx);
      164 |
    > 165 |       expect(res.status).toHaveBeenCalledWith(200);
          |                          ^
      166 |       expect(res.json).toHaveBeenCalledWith(expect.objectContaining({
      167 |         totalUsers: 2,
      168 |         athleteUsers: 1,

      at Object.<anonymous> (src/index.test.ts:165:26)

  ● admin-handler › GET /api/admin/users › returns enhanced user list with pagination

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 200
    Received: 500

    Number of calls: 1

      214 |       await handler(req, res, ctx);
      215 |
    > 216 |       expect(res.status).toHaveBeenCalledWith(200);
          |                          ^
      217 |       expect(res.json).toHaveBeenCalledWith(
      218 |         expect.objectContaining({
      219 |           data: expect.arrayContaining([

      at Object.<anonymous> (src/index.test.ts:216:26)

  ● admin-handler › PATCH /api/admin/users/:id › updates user tier and admin status

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      Object {
    -   "isAdmin": true,
    +   "is_admin": true,
        "tier": "athlete",
      },

    Number of calls: 1

      309 |       await handler(req, res, ctx);
      310 |
    > 311 |       expect(mockUpdate).toHaveBeenCalledWith({ tier: 'athlete', isAdmin: true });
          |                          ^
      312 |       expect(res.status).toHaveBeenCalledWith(200);
      313 |       expect(res.json).toHaveBeenCalledWith({ success: true });
      314 |     });

      at Object.<anonymous> (src/index.test.ts:311:26)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 11 passed, 14 total
Snapshots:   0 total
Time:        2.401 s, estimated 3 s
Ran all test suites.
npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path /home/ripixel/dev/fitglue/server/src/typescript/admin-handler
npm error workspace admin-handler@1.0.0
npm error location /home/ripixel/dev/fitglue/server/src/typescript/admin-handler
npm error command failed
npm error command sh -c jest --verbose
