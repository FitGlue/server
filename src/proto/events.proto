syntax = "proto3";

package fitglue.events;

option go_package = "github.com/fitglue/server/src/go/pkg/types/pb";

import "google/protobuf/descriptor.proto";
import "google/protobuf/timestamp.proto";
import "standardized_activity.proto";
import "activity.proto";

extend google.protobuf.EnumValueOptions {
  string ce_type = 50000;
  string ce_source = 50001;
  string dest_topic = 50002;
}

// CloudEventType enumerates all valid event types in the system.
enum CloudEventType {
  CLOUD_EVENT_TYPE_UNSPECIFIED = 0;
  // Activity Created: Payload is ActivityPayload
  CLOUD_EVENT_TYPE_ACTIVITY_CREATED = 1 [(ce_type) = "com.fitglue.activity.created"];
  // Activity Enriched: Payload is ActivityPayload
  CLOUD_EVENT_TYPE_ACTIVITY_ENRICHED = 2 [(ce_type) = "com.fitglue.activity.enriched"];
  // Job Routed: Payload is ActivityPayload
  CLOUD_EVENT_TYPE_JOB_ROUTED = 3 [(ce_type) = "com.fitglue.job.routed"];
  // Fitbit Notification: Payload is FitbitNotification (raw JSON)
  CLOUD_EVENT_TYPE_FITBIT_NOTIFICATION = 4 [(ce_type) = "com.fitglue.fitbit.notification"];
  // Enrichment Lag: Payload is ActivityPayload
  CLOUD_EVENT_TYPE_ENRICHMENT_LAG = 5 [(ce_type) = "com.fitglue.enrichment.lag"];
  // Input Resolved: Payload is ActivityPayload (resumed)
  CLOUD_EVENT_TYPE_INPUT_RESOLVED = 6 [(ce_type) = "com.fitglue.input.resolved"];
  // Parkrun Results Available: Triggers resume for pending Parkrun activities
  CLOUD_EVENT_TYPE_PARKRUN_RESULTS = 7 [(ce_type) = "com.fitglue.parkrun.results"];
}

// CloudEventSource strings are URI references.
enum CloudEventSource {
  CLOUD_EVENT_SOURCE_UNSPECIFIED = 0;
  CLOUD_EVENT_SOURCE_HEVY = 1 [(ce_source) = "/integrations/hevy"];
  CLOUD_EVENT_SOURCE_FITBIT_WEBHOOK = 2 [(ce_source) = "/integrations/fitbit/webhook"];
  CLOUD_EVENT_SOURCE_FITBIT_INGEST = 3 [(ce_source) = "/integrations/fitbit/ingest"];
  CLOUD_EVENT_SOURCE_ENRICHER = 4 [(ce_source) = "/core/enricher"];
  CLOUD_EVENT_SOURCE_ROUTER = 5 [(ce_source) = "/core/router"];
  CLOUD_EVENT_SOURCE_INPUTS_HANDLER = 6 [(ce_source) = "/core/inputs-handler"];
  CLOUD_EVENT_SOURCE_PARKRUN_RESULTS = 7 [(ce_source) = "/integrations/parkrun/results"];
  CLOUD_EVENT_SOURCE_FILE_UPLOAD = 8 [(ce_source) = "/integrations/file-upload"];
  CLOUD_EVENT_SOURCE_STRAVA = 9 [(ce_source) = "/integrations/strava"];
  CLOUD_EVENT_SOURCE_OURA = 10 [(ce_source) = "/integrations/oura"];
  CLOUD_EVENT_SOURCE_POLAR_WEBHOOK = 11 [(ce_source) = "/integrations/polar/webhook"];
  CLOUD_EVENT_SOURCE_WAHOO = 12 [(ce_source) = "/integrations/wahoo"];
  CLOUD_EVENT_SOURCE_PIPELINE_SPLITTER = 13 [(ce_source) = "/core/pipeline-splitter"];
  CLOUD_EVENT_SOURCE_MOCK = 99 [(ce_source) = "/integrations/mock"];
}

// Destination defines where enriched activities are routed.
// Each destination supports both CREATE and UPDATE operations (determined by use_update_method flag).
enum Destination {
  DESTINATION_UNSPECIFIED = 0;
  DESTINATION_STRAVA = 1 [(dest_topic) = "topic-job-upload-strava"];
  DESTINATION_SHOWCASE = 2 [(dest_topic) = "topic-job-upload-showcase"];
  DESTINATION_HEVY = 3 [(dest_topic) = "topic-job-upload-hevy"];
  DESTINATION_TRAININGPEAKS = 4 [(dest_topic) = "topic-job-upload-trainingpeaks"];
  DESTINATION_INTERVALS = 5 [(dest_topic) = "topic-job-upload-intervals"];
  DESTINATION_GOOGLESHEETS = 6 [(dest_topic) = "topic-job-upload-googlesheets"];
  DESTINATION_MOCK = 99 [(dest_topic) = "topic-job-upload-mock"];
}

// Event payload for CLOUD_EVENT_TYPE_ACTIVITY_ENRICHED
// Also used contextually for Upload Trigger
message EnrichedActivityEvent {
  string activity_id = 1;
  string user_id = 2;
  string pipeline_id = 3;
  string fit_file_uri = 4;
  string name = 5;
  string description = 6;
  ActivityType activity_type = 7;
  google.protobuf.Timestamp start_time = 8;

  // Restored fields from activity.proto consolidation:
  ActivitySource source = 9;
  StandardizedActivity activity_data = 10;
  repeated string applied_enrichments = 11;
  map<string, string> enrichment_metadata = 12;
  repeated Destination destinations = 13;
  repeated string tags = 14;

  // Execution tracing
  optional string pipeline_execution_id = 15;

  // GCS URI for activity_data when too large for Pub/Sub (>5MB)
  // When set, activity_data field is empty and consumers should fetch from GCS
  // Format: gs://{bucket}/enriched_events/{userId}/{pipelineExecutionId}.json
  string activity_data_uri = 16;
}

message MessagePublishedData {
  bytes data = 1;
  map<string, string> attributes = 2;
  string message_id = 3;
  string publish_time = 4;
}

// NOTE: StravaUpdateEvent removed - UPDATE is now handled by ActivityPayload with use_update_method=true
