syntax = "proto3";
package fitglue;

import "google/protobuf/timestamp.proto";
import "standardized_activity.proto";
import "activity.proto";
import "events.proto";

option go_package = "github.com/fitglue/server/src/go/pkg/types/pb";

message UserRecord {
  string user_id = 1;
  google.protobuf.Timestamp created_at = 2;
  UserIntegrations integrations = 3;
  // Field 4 was pipelines (moved to sub-collection users/{userId}/pipelines)
  repeated string fcm_tokens = 5;

  // Pricing tier
  UserTier tier = 6;
  // Athlete trial end date (null = no trial, set to now+30d on signup)
  google.protobuf.Timestamp trial_ends_at = 7;
  // Admin override - grants Pro access without payment
  bool is_admin = 8;
  // Monthly sync tracking
  int32 sync_count_this_month = 9;
  google.protobuf.Timestamp sync_count_reset_at = 10;
  // Track prevented syncs for marketing/upsell
  int32 prevented_sync_count = 11;
  // Stripe customer ID for billing
  string stripe_customer_id = 12;
  // Waitlist gate - false until admin enables access
  bool access_enabled = 13;
}

enum UserTier {
  USER_TIER_UNSPECIFIED = 0;
  USER_TIER_HOBBYIST = 1;
  USER_TIER_ATHLETE = 2;
}


message PipelineConfig {
  string id = 1; // Unique ID (uuid) for tracing
  string source = 2; // e.g. "SOURCE_HEVY"
  repeated EnricherConfig enrichers = 3;
  repeated fitglue.events.Destination destinations = 4;
  string name = 5; // Optional user-friendly name (e.g., "Morning Gym Sessions")
  bool disabled = 6; // When true, pipeline is temporarily disabled and skipped by enricher
}

message UserIntegrations {
  HevyIntegration hevy = 1;
  FitbitIntegration fitbit = 2;
  StravaIntegration strava = 3;
  MockIntegration mock = 4;
  ParkrunIntegration parkrun = 5;
  SpotifyIntegration spotify = 6;
  TrainingPeaksIntegration trainingpeaks = 7;
  IntervalsIntegration intervals = 8;
  GoogleIntegration google = 9;
  OuraIntegration oura = 10;
  PolarIntegration polar = 11;
  WahooIntegration wahoo = 12;
}

message MockIntegration {
    bool enabled = 1;
    google.protobuf.Timestamp created_at = 2;
    google.protobuf.Timestamp last_used_at = 3;
}

message HevyIntegration {
  bool enabled = 1;
  string api_key = 2;
  string user_id = 3;
  google.protobuf.Timestamp created_at = 4;
  google.protobuf.Timestamp last_used_at = 5;
}

message FitbitIntegration {
    bool enabled = 1;
    string access_token = 2;
    string refresh_token = 3;
    google.protobuf.Timestamp expires_at = 4;
    string fitbit_user_id = 5;
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp last_used_at = 7;
}

message SourceEnrichmentConfig {
  repeated EnricherConfig enrichers = 1;
}

message EnricherConfig {
  // Use strictly typed provider enum instead of string name
  EnricherProviderType provider_type = 1;
  // Type-safe configuration map (validated against PluginManifest.config_schema)
  // Keys and values are descriptive strings, not numeric enum values
  map<string, string> typed_config = 2;
}

enum EnricherProviderType {
  ENRICHER_PROVIDER_UNSPECIFIED = 0;
  ENRICHER_PROVIDER_FITBIT_HEART_RATE = 1;
  // Config inputs: "format" (compact/detailed/verbose), "show_stats" ("true"/"false")
  ENRICHER_PROVIDER_WORKOUT_SUMMARY = 2;
  ENRICHER_PROVIDER_MUSCLE_HEATMAP = 3;
  ENRICHER_PROVIDER_SOURCE_LINK = 4;
  // 5 was METADATA_PASSTHROUGH (removed)
  ENRICHER_PROVIDER_VIRTUAL_GPS = 6;
  ENRICHER_PROVIDER_TYPE_MAPPER = 7;
  ENRICHER_PROVIDER_PARKRUN = 8;
  ENRICHER_PROVIDER_CONDITION_MATCHER = 9;
  ENRICHER_PROVIDER_AUTO_INCREMENT = 10;
  ENRICHER_PROVIDER_USER_INPUT = 11;
  // Config inputs: "exclude_activity_types" (comma-separated), "exclude_title_contains" (string)
  ENRICHER_PROVIDER_ACTIVITY_FILTER = 12;
  // Config inputs: "logic_config" (JSON string with rules, match_mode, on_match, on_no_match)
  ENRICHER_PROVIDER_LOGIC_GATE = 13;
  // Config inputs: none (calculates min/avg/max HR from existing heartrate data)
  ENRICHER_PROVIDER_HEART_RATE_SUMMARY = 14;
  // Config inputs: "mode" (title/description/both) - Athlete tier only
  ENRICHER_PROVIDER_AI_COMPANION = 15;
  // Config inputs: none (calculates from speed data, formats as min/km for running)
  ENRICHER_PROVIDER_PACE_SUMMARY = 16;
  // Config inputs: none (calculates avg/max cadence from cadence data)
  ENRICHER_PROVIDER_CADENCE_SUMMARY = 17;
  // Config inputs: none (calculates avg/max power from power data)
  ENRICHER_PROVIDER_POWER_SUMMARY = 18;
  // Config inputs: none (calculates avg/max speed from speed data)
  ENRICHER_PROVIDER_SPEED_SUMMARY = 19;
  // Config inputs: "cardio_records" (boolean), "strength_records" (boolean), "celebrate_in_title" (boolean)
  ENRICHER_PROVIDER_PERSONAL_RECORDS = 20;
  ENRICHER_PROVIDER_TRAINING_LOAD = 21;
  // Config inputs: none (fetches Spotify tracks played during activity time window)
  ENRICHER_PROVIDER_SPOTIFY_TRACKS = 22;
  // Config inputs: "include_wind" (boolean, default true) - adds weather conditions to outdoor activities
  ENRICHER_PROVIDER_WEATHER = 23;
  // Config inputs: none (calculates elevation gain/loss/max from altitude data)
  ENRICHER_PROVIDER_ELEVATION_SUMMARY = 24;
  // Config inputs: "mode" (title/description), "title_template", "fallback_enabled" - generates location-based titles from GPS
  ENRICHER_PROVIDER_LOCATION_NAMING = 25;
  // Config inputs: none (generates SVG muscle activation image) - Athlete tier only
  ENRICHER_PROVIDER_MUSCLE_HEATMAP_IMAGE = 26;
  // Config inputs: "width", "height", "style", "line_color", "line_width" - generates static map image of GPS route - Athlete tier only
  ENRICHER_PROVIDER_ROUTE_THUMBNAIL = 27;
  // Config inputs: "style" (vibrant/minimal/dramatic), "subject" (male/female/abstract) - generates AI banner image for Showcase - Athlete tier only
  ENRICHER_PROVIDER_AI_BANNER = 28;
  // Config inputs: none (requests FIT file upload via pending input, extracts HR data for merging)
  ENRICHER_PROVIDER_FIT_FILE_HEART_RATE = 29;
  // Config inputs: none (allows tagging and merging laps for hybrid races like Hyrox, ATHX)
  ENRICHER_PROVIDER_HYBRID_RACE_TAGGER = 30;
  // Config inputs: none (summarizes ground contact time, vertical oscillation, etc.) - Athlete tier only
  ENRICHER_PROVIDER_RUNNING_DYNAMICS = 31;
  ENRICHER_PROVIDER_MOCK = 99;
}

// Workout Summary format styles
enum WorkoutSummaryFormat {
  WORKOUT_SUMMARY_FORMAT_UNSPECIFIED = 0;
  WORKOUT_SUMMARY_FORMAT_COMPACT = 1;     // "4Ã—8@100kg"
  WORKOUT_SUMMARY_FORMAT_DETAILED = 2;    // "4 sets Ã— 8 reps @ 100.0kg"
  WORKOUT_SUMMARY_FORMAT_VERBOSE = 3;     // "4 sets of 8 reps at 100.0 kilograms"
}

// Muscle Heatmap visualization styles
enum MuscleHeatmapStyle {
  MUSCLE_HEATMAP_STYLE_UNSPECIFIED = 0;
  MUSCLE_HEATMAP_STYLE_EMOJI_BARS = 1;    // "ðŸŸªðŸŸªðŸŸªâ¬œâ¬œ"
  MUSCLE_HEATMAP_STYLE_PERCENTAGE = 2;    // "Chest: 80%"
  MUSCLE_HEATMAP_STYLE_TEXT_ONLY = 3;     // "High: Chest, Medium: Legs"
}

// Muscle Heatmap coefficient presets
enum MuscleHeatmapPreset {
  MUSCLE_HEATMAP_PRESET_UNSPECIFIED = 0;
  MUSCLE_HEATMAP_PRESET_STANDARD = 1;      // Balanced coefficients
  MUSCLE_HEATMAP_PRESET_POWERLIFTING = 2;  // Emphasize compounds
  MUSCLE_HEATMAP_PRESET_BODYBUILDING = 3;  // Emphasize isolation
}

// Virtual GPS route options
enum VirtualGPSRoute {
  VIRTUAL_GPS_ROUTE_UNSPECIFIED = 0;
  VIRTUAL_GPS_ROUTE_LONDON = 1;      // London Hyde Park (~4km)
  VIRTUAL_GPS_ROUTE_NYC = 2;         // NYC Central Park (~10km)
}

message StravaIntegration {
    bool enabled = 1;
    string access_token = 2;
    string refresh_token = 3;
    google.protobuf.Timestamp expires_at = 4;
    int64 athlete_id = 5;
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp last_used_at = 7;
}

message ParkrunIntegration {
    bool enabled = 1;
    string athlete_id = 2;            // Barcode number e.g., "A12345"
    string country_url = 3;           // e.g., "www.parkrun.org.uk"
    bool consent_given = 4;           // GDPR consent for data fetching
    google.protobuf.Timestamp created_at = 5;
    google.protobuf.Timestamp last_used_at = 6;
}

message SpotifyIntegration {
    bool enabled = 1;
    string access_token = 2;
    string refresh_token = 3;
    google.protobuf.Timestamp expires_at = 4;
    string spotify_user_id = 5;
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp last_used_at = 7;
}

message TrainingPeaksIntegration {
    bool enabled = 1;
    string access_token = 2;
    string refresh_token = 3;
    google.protobuf.Timestamp expires_at = 4;
    string athlete_id = 5;                // TrainingPeaks athlete ID
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp last_used_at = 7;
}

message IntervalsIntegration {
    bool enabled = 1;
    string api_key = 2;                   // Intervals.icu API key (used as Basic Auth username)
    string athlete_id = 3;                // Intervals.icu athlete ID
    google.protobuf.Timestamp created_at = 4;
    google.protobuf.Timestamp last_used_at = 5;
}

message OuraIntegration {
    bool enabled = 1;
    string access_token = 2;
    string refresh_token = 3;
    google.protobuf.Timestamp expires_at = 4;
    string oura_user_id = 5;              // Oura user ID
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp last_used_at = 7;
}

message GoogleIntegration {
    bool enabled = 1;
    string access_token = 2;
    string refresh_token = 3;
    google.protobuf.Timestamp expires_at = 4;
    string google_user_id = 5;            // Google user ID
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp last_used_at = 7;
}

message PolarIntegration {
    bool enabled = 1;
    string access_token = 2;
    string refresh_token = 3;
    google.protobuf.Timestamp expires_at = 4;
    string polar_user_id = 5;             // Polar AccessLink user ID
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp last_used_at = 7;
}

message WahooIntegration {
    bool enabled = 1;
    string access_token = 2;
    string refresh_token = 3;
    google.protobuf.Timestamp expires_at = 4;
    string wahoo_user_id = 5;             // Wahoo Cloud user ID
    google.protobuf.Timestamp created_at = 6;
    google.protobuf.Timestamp last_used_at = 7;
}


message ProcessedActivityRecord {
  string source = 1;
  string external_id = 2; // Unique ID from provider
  google.protobuf.Timestamp processed_at = 3;
}

message Counter {
  string id = 1; // Key, e.g. "parkrun_bushy"
  int64 count = 2;
  google.protobuf.Timestamp last_updated = 3;
}

// Personal Record for tracking PRs across cardio and strength activities
// Stored in users/{userId}/personal_records/{recordType}
message PersonalRecord {
  string record_type = 1;  // e.g. "fastest_5k", "bench_press_1rm"
  double value = 2;        // The record value (seconds for time, kg for weight, meters for distance)
  string unit = 3;         // "seconds", "kg", "meters", "reps"
  string activity_id = 4;  // Activity where this PR was achieved
  google.protobuf.Timestamp achieved_at = 5;
  ActivityType activity_type = 6;
  optional double previous_value = 7;  // Previous PR value (for improvement tracking)
  optional double improvement = 8;     // Percentage improvement
}

// ParkrunResultsState tracks the state of official results enrichment
enum ParkrunResultsState {
  PARKRUN_RESULTS_STATE_UNSPECIFIED = 0;
  PARKRUN_RESULTS_STATE_PENDING = 1;        // Awaiting results fetch (auto-populated pending input created)
  PARKRUN_RESULTS_STATE_COMPLETE = 2;       // Results applied via resume
  PARKRUN_RESULTS_STATE_EXPIRED = 3;        // Polling deadline passed, no results found
  PARKRUN_RESULTS_STATE_IMMEDIATE = 4;      // Results found during initial enrichment (no pending input)
}

// ShowcasedActivity represents a publicly shareable activity snapshot.
// Stored in top-level showcased_activities/{showcase_id} collection.
message ShowcasedActivity {
  string showcase_id = 1;              // Human-readable ID (e.g., "morning-run-2026-01-17")
  string activity_id = 2;              // Original FitGlue activity ID
  string user_id = 3;                  // Owner (for tier lookup, not displayed publicly)

  // Activity metadata
  string title = 4;
  string description = 5;
  ActivityType activity_type = 6;
  ActivitySource source = 7;
  google.protobuf.Timestamp start_time = 8;

  // Full activity data for rendering
  StandardizedActivity activity_data = 9;
  string fit_file_uri = 10;            // GCS URI for FIT file

  // Enrichment info
  repeated string applied_enrichments = 11;
  map<string, string> enrichment_metadata = 12;
  repeated string tags = 13;
  optional string pipeline_execution_id = 14;

  // Lifecycle
  google.protobuf.Timestamp created_at = 15;
  google.protobuf.Timestamp expires_at = 16;  // null = never expires (Athlete tier)

  // Public attribution
  string owner_display_name = 17;  // User's display name for public attribution

  // GCS URI for pre-parsed activity JSON (avoids Firestore 1MB limit)
  string activity_data_uri = 18;
}

// PipelineRun tracks a complete pipeline execution lifecycle.
// This is the primary entity for user-facing activity views, replacing the
// old SynchronizedActivity + executions pattern.
// Stored in: users/{userId}/pipeline_runs/{pipelineRunId}
message PipelineRun {
  string id = 1;                           // pipelineExecutionId
  string pipeline_id = 2;                  // Which pipeline config
  string activity_id = 3;                  // Generated activity ID

  // Source Info
  string source = 4;                       // SOURCE_HEVY, SOURCE_STRAVA, etc.
  string source_activity_id = 5;           // External ID from source

  // Activity Summary (denormalized for list display)
  string title = 6;
  string description = 7;
  ActivityType type = 8;
  google.protobuf.Timestamp start_time = 9;

  // Pipeline Status
  PipelineRunStatus status = 10;
  google.protobuf.Timestamp created_at = 11;
  google.protobuf.Timestamp updated_at = 12;

  // Booster Executions
  repeated BoosterExecution boosters = 13;

  // Destination Outcomes
  repeated DestinationOutcome destinations = 14;

  // Status tracking
  optional string status_message = 15;  // General message for any status (success/skip/fail/etc)
  optional string pending_input_id = 16;

  // For repost/retry functionality (replaces executions.inputsJson)
  reserved 20;  // was enriched_event (exceeds 1MB Firestore limit for long activities)
  reserved 21;  // was original_payload (exceeds 1MB Firestore limit)
  string original_payload_uri = 22;  // GCS URI: gs://{bucket}/payloads/{userId}/{activityId}.json
  string enriched_event_uri = 23;    // GCS URI: gs://{bucket}/enriched_events/{userId}/{pipelineRunId}.json
}

// PipelineRunStatus tracks the overall state of a pipeline execution.
enum PipelineRunStatus {
  PIPELINE_RUN_STATUS_UNSPECIFIED = 0;
  PIPELINE_RUN_STATUS_RUNNING = 1;      // In progress
  PIPELINE_RUN_STATUS_SYNCED = 2;       // All destinations succeeded
  PIPELINE_RUN_STATUS_PARTIAL = 3;      // Some destinations failed
  PIPELINE_RUN_STATUS_FAILED = 4;       // All destinations failed
  PIPELINE_RUN_STATUS_PENDING = 5;      // Waiting for pending input
  PIPELINE_RUN_STATUS_SKIPPED = 6;      // Halted by filter/logic gate
  PIPELINE_RUN_STATUS_ARCHIVED = 7;     // Older than TTL, hidden from default views
}

// BoosterExecution tracks a single enricher provider's execution.
message BoosterExecution {
  string provider_name = 1;              // e.g., "parkrun-results", "workout-summary"
  string status = 2;                     // SUCCESS, SKIPPED, FAILED, WAITING
  int64 duration_ms = 3;
  map<string, string> metadata = 4;      // Provider-specific output (e.g., skip_reason)
  optional string error = 5;
}

// DestinationOutcome tracks the result of sending to a single destination.
message DestinationOutcome {
  fitglue.events.Destination destination = 1;
  DestinationStatus status = 2;
  optional string external_id = 3;       // ID from destination platform
  optional string error = 4;
  google.protobuf.Timestamp completed_at = 5;
}

// DestinationStatus tracks the status of a single destination upload.
enum DestinationStatus {
  DESTINATION_STATUS_UNSPECIFIED = 0;
  DESTINATION_STATUS_PENDING = 1;
  DESTINATION_STATUS_SUCCESS = 2;
  DESTINATION_STATUS_FAILED = 3;
  DESTINATION_STATUS_SKIPPED = 4;        // Not in pipeline config or filtered
}
